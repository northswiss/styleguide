<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Travelperk Front End Style Guide</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="./style.css">
  </head>
  <body>
    <div class="content">
      <h1>The TravelPerk Front End Style Guide</h1>

      <div id="toc"></div>

      <h2>Introduction</h2>

      <p>
      This guide is a living document on how to write React applications at TravelPerk, expect it to change over time. Keep an eye on it to be up-to-date with our latest development practices.
      </p>

      <p>
      Feel free to link or quote sections of this guide in your pull request reviews.
      <p>

      <p>
      If you think parts of the guide are no longer valid or can be improved open a <a href="https://github.com/travelperk/styleguide">pull request</a>
      and ask the rest of the team to review it.
      </p>

      <p>
      The chapters should be read in order. They start with the basic notions to setup a project and go to more advanced concepts.
      The idea is that if you just joined TravelPerk, after reading this document, you'll be able to work on our front end code.
      If that's not the case please raise your concerns with the members of your team.
      </p>

      <hr>

      <p>
      You will find the following boxes, here's what they mean:
      </p>

      <div class="info" data-title="Pro Tip">
        This is a note with some helpful tips.
      </div>

      <div class="idea" data-title="Idea">
        This is an idea of a possible improvement to our setup. Feel free to work on it if you have the time.
      </div>

      <div class="disclaimer" data-title="Warning">
        This is a warning, keep an eye on this for common errors or possible bad practices.
      </div>

      <h2>How to Setup a Project</h2>

      <p>
      Create you React projects using <em><a href="https://github.com/facebookincubator/create-react-app">Create React App</a></em> this will give you a solid starting point and free upgrades.
      Don't <a href="https://github.com/facebookincubator/create-react-app#converting-to-a-custom-setup">eject</a> unless you have a very good reason for doing so.
      If you want to eject check with the rest of the team first.
      </p>

      <h3>Additional Tools</h3>

      <p>
      Once you have your project setup with Create React App, you will still need some extra configuration.
      </p>

      <h4>Node.js and npm</h4>

      <p>
      Make sure you specify your <a href="https://nodejs.org/en/">Node.js</a> version in an <code>.nvmrc</code> file for <a href="https://github.com/creationix/nvm">nvm</a> users.
      </p>
      <p>
      Try to use <a href="https://www.npmjs.com/"><code>npm</code></a> over <a href="https://yarnpkg.com/lang/en/"><code>yarn</code></a>. They are both great package managers but
      keeping the same version of <code>npm</code> among the whole team is easier since it's bound to Node.js's version.
      </p>

      <h4>Flow</h4>

      <p>
      We try to type-check all our JavaScript files using <a href="https://flow.org/">Flow</a>. To install Flow, you can simply follow the <a href="https://flow.org/en/docs/install/">installation guide</a>.
      </p>

      <p>
      It's important that you execute <a href="https://github.com/flowtype/flow-typed"><code>flow-typed</code></a> after you setup Flow and every time you install, remove or update a node module.
      </p>

      <div class="idea" data-title="Idea">
        It would be useful if we could configure npm to run <code>flow-typed</code> automatically every time our modules list gets updated.
      </div>

      <h4>Prettier</h4>

      <p>
      Instead of having an extensive style guide dissecting where to put every white space we prefer to use <a href="https://github.com/prettier/prettier">Prettier</a> for automatic code formatting.
      </p>

      <p>
      We set the following flags for prettier: <code>--no-semi --single-quote --jsx-bracket-same-line=false --trailing-comma=es5 --parser=flow</code>.
      </p>

      <p>
      Make sure  you follow the <a href="https://github.com/prettier/prettier#pre-commit-hook">official documentation</a> so that Prettier runs automatically for every new commit.
      </p>

      <h4>Codeship</h4>

      <p>TBD</p>

      <h4>Others</h4>

      <p>
      If you are on a Mac, Jest watch mode might not be working for you. You can fix it by installing or upgrading <a href="https://github.com/facebook/jest/issues/1767#issuecomment-248883102">watchman</a>.
      </p>

      <h3>Folder Structure</h3>

      <p>
      Follow the folder structure made by Create React App as much as possible. That means keeping all your configuration files in the root folder and all the code in <code>src</code>.
      </p>

      <p>
      Inside <code>src/</code> you're going to have a structure similar to the following:
      </p>

      <script src="https://gist.github.com/Gpx/5e6282929d9a8a18d29a86fe7c207b73.js"></script>

      <dl>
        <dt><code>api/</code></dt>
        <dd>
        Contains all the modules that make API requests
        </dd>
        <dt><code>app/</code></dt>
        <dd>
        Contains the whole app
        </dd>
        <dt><code>styles/</code></dt>
        <dd>
        Contains JavaScript modules with styling information. This folder may not be needed for some projects.
        </dd>
        <dt><code>types/</code></dt>
        <dd>
        Contains the Flow definitions for types that are not specified by <code>flow-typed</code>.
        </dd>
        <dt><code>utils/</code></dt>
        <dd>
        Any utility module goes here.
        </dd>
        <dt><code>index.js</code></dt>
        <dd>
        The main JavaScript files that bootstraps the whole application
        </dd>
        <dt><code>setupTests.js</code></dt>
        <dd>
        A file that gets executed before the tests are launched.
        </dd>
      </dl>

      <p>
      All the static files that are not imported via JavaScript&mdash;e.g. <code>index.html</code>, favicons&mdash;are placed in the <code>public/</code> folder.
      </p>

      <h2>Code Style</h2>

      <p>
      As said we leave code formatting to Prettier, there are also some <a href="http://eslint.org/">ESLint</a> rules that are automatically set by Create React App.
      </p>

      <div class="idea" data-title="Idea">
      At the time of writing it looks as if it is not possible to configure custom ESLint rules without ejecting from Create React App.
      </div>

      <p>
      Here are some advices on how to write JavaScript code so that is more readable.
      </p>

      <ul>
        <li>Prefer <code>const</code> over <code>let</code>. Code written with constants is often more readable</li>
        <li>
          Never use comments to describe what your program is doing. The code should be easy to read and understand.
          Comments are a useful tool to explain why you wrote a portion of your program in a certain way but not to clarify what's going on in the program.
          Even worse, if you update your code the comments no longer describe your logic. Consider the following examples.

          <script src="https://gist.github.com/Gpx/59ce150791db7c354fef717faefee87e.js"></script>
        </li>
        <li>
          Learn <code>Array</code> methods, in particular <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/filter"><code>filter</code></a>,
          <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/find"><code>find</code></a>,
          <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/includes"><code>includes</code></a>,
          <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/map"><code>map</code></a>,
          <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/forEach"><code>forEach</code></a>,
          <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/reduce"><code>reduce</code></a> and,
          <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/some"><code>some</code></a>. With these methods you'll be able to get rid of loop statements 90% of the time.
        </li>
      </ul>

      <h2>How to Write a Component</h2>

      <p>
      There are two different kinds of components: Containers and Presentational—sometimes also called Smart and Dumb. You can read more about them <a href="https://medium.com/@dan_abramov/smart-and-dumb-components-7ca2f9a7c7d0">here</a>.
      </p>

      <h3>Presentational Components</h3>

      </p>
      Presentational Components are the easiest ones. Ideally, all they do is to take some data in—via <code>props</code>—and render it on the screen.
      A Presentational Component might have an internal state (e.g. if it handles an input element), but it should never communicate directly with the server.
      </p>

      <p>
      If possible create your Presentational Components using a functional style:
      </p>

      <script src="https://gist.github.com/Gpx/b7e8ecfa22a42a5a91796129ef7f1870.js"></script>

      <div class="info" data-title="Note">
        We're going to use Flow in all the examples. If you're not sure how to use it feel free to skip to Flow's chapter.
      </div>

      <p>
      If you need helper methods, just create them in the same file or import them from a module.
      </p>

      <script src="https://gist.github.com/Gpx/c1939ca3390497f27eede6a9f6d7401e.js"></script>

      <p>
      Having several presentational components is OK. In fact, a good React application is made of many small components rather than few huge ones.
      Small components are easier to write, test and maintain.
      </p>

      <div class="info" data-title="Pro Tip">
        Don't worry too much about performance issues in the beginning. Fixing slow code will be faster if it's well written and easy to read.
      </div>

      <h3>Container Components</h3>

      <p>
      Containers Components take care of everything that is not strictly visual:
      </p>
      <ul>
        <li>Fetching data</li>
        <li>Handling the internal state of the application</li>
        <li>Notifying the server about updates</li>
        <li>Routing</li>
      </ul>
      <p>
      Every app has at least one Container called <code>&lt;App&gt;</code>.
      </p>

      <p>
      A container is defined as a <code>class</code> because it has to hold an internal state.
      </p>

      <script src="https://gist.github.com/Gpx/c3b7e3d46ea7eb88ca624df6bfc13063.js"></script>

      <p>
      In the previous example, we created a container called <code>&lt;MyPageContainer&gt;</code> and initialized its state to hold some users.
      </p>
      <p>
      The container is rendering <code>&lt;MyPage&gt;</code> which is a presentational component.
      </p>
      <p>
      As you can see <code>users</code> is initially <code>null</code> because we have to fetch the users from the server. Let's do it now.
      </p>

      <script src="https://gist.github.com/Gpx/431e000265be119f8af0484b01d2d8dc.js"></script>

      <p>
      Here we use <a href="https://facebook.github.io/react/docs/react-component.html#componentdidmount"><code>componentDidMount</code></a> to initiate the fetch.
      The <code>fetchUser</code> method is pretty straightforward, it loads the users and saves them in the state. The reason why we have a separate method for fetching
      is that it will be easer to test.
      </p>

      <div class="disclaimer" data-title="Warning">
        Instance methods declared as <a href="https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Functions/Arrow_functions">arrow functions</a> don't appear in
        the <code>prototype</code> and can not be mocked during tests. Stick with normal functions and <code>bind</code> them in the <code>constructor</code> like we do
        in the examples.
      </div>

      <p>
      Note that <code>componentDidMount</code> can initiate more than one fetch at the time.
      </p>

      <p>
      Lastly, we updated the <code>render</code> method so that it returns a <code>&lt;Loading&gt;</code> component while <code>users</code> is <code>null</code>.
      </p>

      <h4>Containers Inside Containers</h4>

      <p>
      Roughly speaking each container represents one segment in your URL path. For example, if your users visit <code>/settings/users</code> three container components will
      be activated: <code>&lt;App&gt;</code>, <code>&lt;SettingsContainer&gt;</code> and <code>&lt;UsersContainer&gt;</code>.
      </p>

      <p>
      The important thing is that all the containers have separate purposes. In our case, since <code>&lt;App&gt;</code> is loading the logged in user there's no need to fetch it
      again in <code>&lt;UsersContainer&gt;</code>.
      </p>

      <p>
      Make sure your folder structure maps the hierarchy in the containers.
      </p>

      <script src="https://gist.github.com/Gpx/c11e5cffa259a8f0f8350ff6605977dd.js"></script>

      <h4>Where to Put the Data</h4>

      <p>
      Given that your application is structured like a tree you want to store your data as close as possible to the leafs but at the same time avoid repetition.
      </p>

      <p>
      Say your app has the following structure:
      </p>

      <img src="./app_tree.jpeg">

      <p>
      Here, each node represents a container. The currently logged user will potentially be used by all the components, so we'll store it in <code>&lt;App&gt;</code>'s state.
      </p>

      <p>
      On the other hand, the list of offices will only be used by <code>&lt;Offices&gt;</code>, so we'll keep it there.
      </p>

      <p>
      With time data might need to be moved, usually from the leafs up to the root. That's normal, if you keep your Flow definitions up-to-date it will be fairly easy to migrate.
      </p>

      <h3>Communicate Between Components</h3>

      <p>
      Communication between components is unidirectional. A parent will pass data down to its children via props. If a child needs to notify one of its ancestors,
      it'll have to do that using a function passed as a prop.
      </p>

      <script src="https://gist.github.com/Gpx/fa2d93b17093a77fea6d14820b30be32.js"></script>

      <p>
      In the previous example you can see how <code>&lt;Child&gt;</code> receives <code>flag</code> from its parent and can also notify <code>&lt;Parent&gt;</code> that
      a click happened using the <code>onFlagChange</code> function.
      </p>

      <h2>How to Style</h2>

      <p>
      You should avoid styling your components as much as possible. We have various components that provide basic styling such as <code>&lt;Layout&gt;</code>, <code>&lt;Spacer&gt;</code> and <code>&lt;Text&gt;</code>.
      </p>

      <p>
      Before styling a component ask yourself three questions:
      </p>

      <ol>
        <li>Can I use one of the existing components?</li>
        <li>Seriously though, can I use one of the existing components?</li>
        <li>Can I extend one of the existing components without breaking the <a href="https://en.wikipedia.org/wiki/Single_responsibility_principle">single responsibility principle</a>?</li>
      </ol>

      <p>
      If you answered <em>no</em> to all the previous questions, talk with your designer to see if it's possible to modify the design to use existing components.
      If that's not an option, define with the designer what's the best approach: creating a new general component or only one that will be used in your feature.
      </p>

      <div class="disclaimer" data-title="Warning">
      Make sure developers and designer are always aligned on what new components get created.
      </div>

      <div class="info" data-title="Note">
        The reason why it's so important to use existing components is that they are battle-tested, ensure visual consistency across the app, and they don't require you to write any custom styles.
      </div>

      <p>
      If you can't avoid styling use <a href="http://styled-components.com/">styled-components</a>.
      </p>

      <p>
      Try not to hard code values directly, instead create a <code>variables.js</code> file within <code>src/styles</code>.
      </p>

      <div class="disclaimer" data-title="Warning">
        <code>tk-components</code> already has a module with our variables defined. Try to use it instead of defining your own values.
      </div>

      <h2>How to Test</h2>

      We implement two different kind of tests: unit tests and functional tests.

      <h3>Unit Tests</h3>

      <p>
      Use <a href="http://facebook.github.io/jest/">Jest</a> to write unit tests and keep the test file in the same folder as the code that is being tested.
      Name the test file the same as the original file but add the <code>.test</code> suffix. So, if you're testing <code>Component.js</code> you will have
      <code>Component.test.js</code>.
      </p>

      <p>
      Although unit tests differ depending on what you're testing—a Presentational component or a Container—they all share a similar skeleton.
      </p>

      <script src="https://gist.github.com/Gpx/2f73529f1b0d7b93e7c6e6faee05ec52.js"></script>

      <p>
      The previous example tests a generic <code>&lt;Component&gt;</code>. The <a href="http://facebook.github.io/jest/docs/en/api.html#describename-fn"><code>describe</code></a> method is useful for grouping related tests.
      Remember to add <code>&lt;</code> and <code>&gt;</code> around the component name to signify that it's a React component and not a generic class or function.
      </p>

      <p>
      We're running only one <a href="http://facebook.github.io/jest/docs/en/snapshot-testing.html">snapshot test</a> that checks that the component gets rendered.
      </p>

      <div class="disclaimer" data-title="Warning">
        Snapshot tests are extremely useful to discover subtle bugs but they must be used in conjunction with other tests. Relying on snapshots only makes your tests hard to read and error prone.
      </div>

      <p>
      What's interesting here is the <code>setupComponent</code> method which has three advantages:
      </p>

      <ol>
        <li>Defines default props</li>
        <li>Can find child elements</li>
        <li>Only method that needs to be updated</li>
      </ol>

      <p>
      For the first one, if our component has some props that must be set <code>setupComponent</code> can do that for us:
      </p>

      <script src="https://gist.github.com/Gpx/5fd6d05b971bc02b1903f84033aa94f7.js"></script>

      <p>
      <code>setupComponent</code> is also useful to find child components without having the logic in your tests.
      </p>

      <script src="https://gist.github.com/Gpx/fa8c679c46636652d8de712ece2b1c4e.js"></script>

      <p>
      Last, if your component updates and breaks the logic inside <code>setupComponent</code> you only have to fix it there. Compare this to updating all your test cases.
      </p>

      <hr>

      <p>
      With the basic structure out of the way let's see what should be tested in a component.
      </p>

      <div class="idea" data-title="Idea">
        <code>setupComponent</code> and a lot of the patterns you'll see here are used over and over throughout the codebase.
        It would be useful to extract some of the logic to a helper library.
      </div>

      <h4>Render</h4>

      <p>
      All React components must have a <code>render</code> method. It's important to test that this method returns what we expect.
      In addition to snapshots we can test that what gets rendered is what we expect.
      </p>

      <script src="https://gist.github.com/Gpx/149af50ed773e2b53eb1073683ee892e.js"></script>

      <p>
      Make sure you test all possible outputs for different props configurations. Code coverage can help you figure out if some cases are not tested.
      </p>

      <h4>Events</h4>

      <p>
      If a component exposes some props for event handling you need to test that they fire sending the correct data.
      </p>

      <p>
      Imagine you're implementing an <code>&lt;Input&gt;</code> component, you want at least to have a <code>onChange</code> to notify about changes.
      </p>

      <p>
      This is how you would test it.
      </p>

      <script src="https://gist.github.com/Gpx/31d88286523e0809bfeb7a7a3eefbd61.js"></script>

      <p>
      Of course, you need a test for each event prop you have. In our <code>&lt;Input&gt;</code> example we might have to cover <code>onFocus</code>, <code>onBlur</code> etc...
      </p>

      <p>
        If the way we call <a href="http://airbnb.io/enzyme/docs/api/ShallowWrapper/simulate.html"><code>simulate</code></a> confuses you check out <a href="https://github.com/airbnb/enzyme/issues/76">this discussion</a> and in particular <a href="https://github.com/airbnb/enzyme/issues/76#issuecomment-189606849">this comment</a>.
        In a nutshell, we pass a mocked event simulating the event triggered by the HTML <code>&lt;input&gt;</code> element.
      </p>

      <div class="info" data-title="Pro Tip">
        When calling <code>simulate</code> you can pass other properties too. One that is often useful is <code>preventDefault</code>.
      </div>

      <h4>State and State Mutations</h4>

      <p>
      If your store holds some state you need to test it. First you need to check that your state is correctly initialized.
      </p>

      <script src="https://gist.github.com/Gpx/208c273e39315f66e3a7779796496622.js"></script>

      <p>
      Your state will be updated at some point. If it doesn't it can simply be converted as a constant.
      </p>

      <p>
      Usually state mutations happen as a result of some other event—user interaction, server response—therefore defer to the other sections of this guide to see how to test these situations.
      In general though, you want to check that <code>component.state()</code> contains the properties that you expect at any given time.
      </p>

      <div class="info" data-title="Pro Tip">
        With enzyme you can not only read the sate but only modify it using <a href="http://airbnb.io/enzyme/docs/api/ShallowWrapper/setState.html"><code>setState</code></a>.
        This is very useful when you want to set an initial state for your component before testing it.
      </div>

      <h4>Fetch Calls</h4>

      <p>
      Each interaction with the server has to be tested.
      </p>

      <p>
      Let's say you have a component that renders a button. When the button gets clicked a fetch has to happen. When the fetch is done the state updates.
      This is how the code for this component might look like.
      </p>

      <script src="https://gist.github.com/Gpx/86bcc4e203d9de89bd58b8fb110d0f70.js"></script>

      <p>
      We can now write a test for this feature.
      </p>

      <script src="https://gist.github.com/Gpx/10f4b48e8c4c087a401914b655009dac.js"></script>

      <p>
      As you can see, the test is divided in two. We first test that once the button is clicked the fetch is performed. Then, we check that when the fetch is called the status is updated accordingly.
      </p>

      <p>
      The reason for this is simple, our test need to know when the promise resolve, to do this we need to have the promise. In order for that to happen we need to call the event handler directly.
      </p>

      <p>
      There are two new things in the test example above. The first one is <a href="https://facebook.github.io/jest/docs/en/jest-object.html#jestspyonobject-methodname"><code>jest.spyOn</code></a>
      that takes one method from an object and converts it into a spy. Notice how at the end of the test <a href="https://facebook.github.io/jest/docs/en/mock-function-api.html#mockfnmockrestore"><code>mockRestore</code></a>
      is called to restore the method at its original state. If you fail to do that some of your other tests might fail.
      </p>

      <p>
      The second new item is at the very top of the file and is <a href="https://facebook.github.io/jest/docs/en/jest-object.html#jestmockmodulename-factory-options"><code>jest.mock</code></a>.
      What it does, is taking a module and replacing it with a mocked version of it. In this way we know when the API function would have been called. Also, we avoid real calls to the server.
      </p>

      <div class="disclaimer" data-title="Warning">
        Make sure your unit tests never really contact the server, otherwise they'll be slow, might randomly fail and will flood the server with requests.
      </div>

      <hr>

      <p>
      There's another frequent use case when a container might want to contact the server, at loading time. This is done inside the <code>componentDidMount</code> life cycle method.
      The pattern is very similar, what changes is the way you trigger the call. You can't use <code>simulate</code> for lifecycle events.
      </p>

      <p>
      Enzyme does not fire life cycle methods when you use <code>shallow</code> (although it might in the near future <a href="https://github.com/airbnb/enzyme/pull/789">#789</a>)
      therefore you have to use <a href="http://airbnb.io/enzyme/docs/api/mount.html"><code>mount</code></a>.
      </p>

      <script src="https://gist.github.com/Gpx/f588ac2c2e384272cc3255f0d88f864e.js"></script>

      <p>
      The only difference here is in <code>setupComponent</code> which accepts a second optional parameter <code>mounter</code>. If you want life cycle events methods to be called
      you can simply pass <code>mount</code> instead of the default <code>shallow</code>.
      </p>

      <div class="idea" data-title="Idea">
        <code>mount</code> performs a full DOM rendering which is slower and more error prone. It would be useful to have a way to get life cycle events while using <code>shallow</code>.
      </div>

      <h3>Functional Tests</h3>

      TBD

      <h2>Flow and Data Types</h2>

      <p>
      <a href="https://flow.org/">Flow</a> is an amazing piece of software that can make your life so much easier... when it works.
      Luckily it's getting better and better and if you follow these rules you should not have big issues.
      </p>

      <p>
      Check <em>all</em> your JavaScript files with flow not only React components. To check a file simply add <code>// @flow</code> as the first line.
      </p>

      <h3>Type Check React Components</h3>

      <p>
      Refer to the <a href="https://flow.org/en/docs/react/">official docs</a> on how to test a React component. One thing to notice is that
      we use exact types to define props and state. So instead of <code>{ user: User }</code> we write <code>{| user: User |}</code>.
      </p>

      <h3>Define Types</h3>

      <p>
      We define all our types is <code>src/types/global.js</code>, although in the future we might decide to split this file in sub-modules.
      </p>

      <p>
      These are the convections that we apply.
      </p>

      <ul>
        <li>
          We never export <code>Id</code> since is a very generic type, we prefer to use <a href="https://flow.org/en/docs/types/utilities/#toc-propertytype"><code>$PropertyType&lt;T, x&gt;</code></a>.
          It doesn't change much from Flow's point of view but makes the code more expressive:
          <script src="https://gist.github.com/Gpx/0f189450be500e79f57cbe2ce9ebdb50.js"></script>
        </li>
      </ul>
    </div>

    <script src="./main.js"></script>
  </body>
</html>
